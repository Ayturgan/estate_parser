{% extends "base.html" %}

{% block title %}Логи системы - Estate Parser{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-gradient mb-4">
            <i class="bi bi-journal-text"></i> Логи системы
        </h1>
    </div>
</div>

<!-- Выбор типа логов -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Выбор логов</h5>
            </div>
            <div class="card-body">
                <div class="btn-group mb-3" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="showSystemLogs()">
                        <i class="bi bi-cpu"></i> Системные
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="showScrapingLogs()">
                        <i class="bi bi-cloud-download"></i> Парсинг
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="showProcessingLogs()">
                        <i class="bi bi-gear-wide-connected"></i> Обработка
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="showErrorLogs()">
                        <i class="bi bi-exclamation-triangle"></i> Ошибки
                    </button>
                </div>
                
                <div class="d-flex">
                    <label class="form-check-label me-3">
                        <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                        Автообновление
                    </label>
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="refreshLogs()">
                        <i class="bi bi-arrow-clockwise"></i> Обновить
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearLogs()">
                        <i class="bi bi-trash"></i> Очистить
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Контейнер для логов -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-terminal"></i> <span id="logs-title">Системные логи</span>
                </h5>
                <div>
                    <span class="badge bg-light text-dark" id="logs-count">0 строк</span>
                    <span class="badge bg-success" id="logs-status">
                        <i class="bi bi-circle-fill"></i> Live
                    </span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="log-container" id="logs-container" style="height: 500px;">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-3 text-muted">Загрузка логов...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Статистика логов -->
<div class="row mt-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <h4 class="mb-0" id="success-count">0</h4>
                <small>Успешных</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <h4 class="mb-0" id="info-count">0</h4>
                <small>Информационных</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <h4 class="mb-0" id="warning-count">0</h4>
                <small>Предупреждений</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-white bg-danger">
            <div class="card-body text-center">
                <h4 class="mb-0" id="error-count">0</h4>
                <small>Ошибок</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentLogType = 'system';

function showSystemLogs() { switchLogType('system', 'Системные логи'); }
function showScrapingLogs() { switchLogType('scraping', 'Логи парсинга'); }
function showProcessingLogs() { switchLogType('processing', 'Логи обработки'); }
function showErrorLogs() { switchLogType('error', 'Ошибки'); }

function switchLogType(type, title) {
    currentLogType = type;
    document.getElementById('logs-title').textContent = title;
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    loadLogs();
}

async function loadLogs() {
    const container = document.getElementById('logs-container');
    container.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-3 text-muted">Загрузка логов ${currentLogType}...</p>
        </div>
    `;
    
    try {
        // Маппинг типов логов для API
        const logTypeMap = {
            'system': 'app',
            'scraping': 'scraping', 
            'processing': 'processing',
            'error': 'app'
        };
        
        const apiLogType = logTypeMap[currentLogType] || 'app';
        let url = `/api/logs/${apiLogType}?limit=200`;
        
        // Для ошибок добавляем фильтр по уровню
        if (currentLogType === 'error') {
            url += '&level=ERROR';
        }
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        displayLogs(data.logs || []);
        updateLogStats(data.logs || []);
        
    } catch (error) {
        console.error('Ошибка загрузки логов:', error);
        container.innerHTML = `
            <div class="text-center py-5 text-danger">
                <i class="bi bi-exclamation-triangle fs-1"></i>
                <p class="mt-3">Ошибка загрузки логов: ${error.message}</p>
                <button class="btn btn-outline-primary" onclick="loadLogs()">Повторить</button>
            </div>
        `;
    }
}

function displayLogs(logs) {
    const container = document.getElementById('logs-container');
    const html = logs.map(log => {
        const level = detectLogLevel(log);
        return `<div class="log-line ${level}">${escapeHtml(log)}</div>`;
    }).join('');
    
    container.innerHTML = html;
    document.getElementById('logs-count').textContent = `${logs.length} строк`;
}

function detectLogLevel(logLine) {
    const line = logLine.toLowerCase();
    if (line.includes('error') || line.includes('ошибка')) return 'error';
    if (line.includes('warning') || line.includes('предупреждение')) return 'warning';
    if (line.includes('success') || line.includes('успешно')) return 'success';
    return 'info';
}

function updateLogStats(logs) {
    let success = 0, info = 0, warning = 0, error = 0;
    logs.forEach(log => {
        const level = detectLogLevel(log);
        switch (level) {
            case 'success': success++; break;
            case 'warning': warning++; break;
            case 'error': error++; break;
            default: info++; break;
        }
    });
    
    document.getElementById('success-count').textContent = success;
    document.getElementById('info-count').textContent = info;
    document.getElementById('warning-count').textContent = warning;
    document.getElementById('error-count').textContent = error;
}

function refreshLogs() {
    loadLogs();
    showNotification('info', 'Логи обновлены');
}

function clearLogs() {
    document.getElementById('logs-container').innerHTML = '';
    document.getElementById('logs-count').textContent = '0 строк';
    updateLogStats([]);
}

document.addEventListener('DOMContentLoaded', function() {
    showSystemLogs();
    
    // Автообновление логов каждые 5 секунд
    setInterval(() => {
        const autoRefresh = document.getElementById('auto-refresh');
        if (autoRefresh && autoRefresh.checked) {
            loadLogs();
        }
    }, 5000);
});
</script>
{% endblock %} 