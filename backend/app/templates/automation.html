{% extends "base.html" %}

{% block title %}–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è{% endblock %}

{% block content %}
<div id="automation-page">
<div class="row">
    <div class="col-12">
        <h1 class="text-gradient mb-4">
            <i class="bi bi-robot"></i> –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
        </h1>
        <p class="text-muted mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–∞–π–ø–ª–∞–π–Ω–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
    </div>
</div>

<!-- –°—Ç–∞—Ç—É—Å –ø–∞–π–ø–ª–∞–π–Ω–∞ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-gear"></i> –°—Ç–∞—Ç—É—Å –ø–∞–π–ø–ª–∞–π–Ω–∞</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                    <div>
                        <span id="pipeline-status" class="badge bg-success pulse">
                            <i class="bi bi-circle-fill"></i> –ì–æ—Ç–æ–≤
                        </span>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <button id="start-btn" class="btn btn-gradient">
                            <i class="bi bi-play-fill"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞–π–ø–ª–∞–π–Ω
                        </button>
                        <button id="stop-btn" class="btn btn-danger" disabled>
                            <i class="bi bi-stop-fill"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                        <button id="refresh-btn" class="btn btn-secondary">
                            <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
                
                <!-- –¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø -->
                <div id="current-stage" style="display: none;" class="mb-3">
                    <h6>–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø: <span id="current-stage-name" class="text-primary"></span></h6>
                    <div id="current-stage-details" class="small text-muted"></div>
                </div>
                
                <!-- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <div class="text-center p-3 bg-light rounded">
                            <small class="text-muted d-block">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫</small>
                            <strong id="last-run-start">‚Äî</strong>
                        </div>
                    </div>
                    <div class="col-md-4 mb-2">
                        <div class="text-center p-3 bg-light rounded">
                            <small class="text-muted d-block">–ó–∞–≤–µ—Ä—à–µ–Ω</small>
                            <strong id="last-run-end">‚Äî</strong>
                        </div>
                    </div>
                    <div class="col-md-4 mb-2">
                        <div class="text-center p-3 bg-light rounded">
                            <small class="text-muted d-block">–°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫</small>
                            <strong id="next-run">‚Äî</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-download"></i> –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –∏—Å—Ç–æ—á–Ω–∏–∫—É
                </div>
                
                <div id="scraping-sources" class="row">
                    <!-- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤...</span>
                        </div>
                        <p class="text-muted mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-gear-fill"></i> –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ <a href="/settings" class="alert-link">—Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫</a>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-4 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º</h6>
                                <span id="config-auto-mode" class="badge {% if automation_config.is_auto_mode %}bg-success{% else %}bg-danger{% endif %}">
                            {% if automation_config.is_auto_mode %}
                                <i class="bi bi-check-circle"></i> –í–∫–ª—é—á–µ–Ω
                            {% else %}
                                <i class="bi bi-x-circle"></i> –û—Ç–∫–ª—é—á–µ–Ω
                            {% endif %}
                        </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">–ò–Ω—Ç–µ—Ä–≤–∞–ª –∑–∞–ø—É—Å–∫–∞</h6>
                                <span id="config-interval" class="badge bg-primary">
                            <i class="bi bi-clock"></i> 
                            {% if automation_config.interval_minutes < 60 %}
                                {{ automation_config.interval_minutes }} –º–∏–Ω.
                            {% else %}
                                {{ automation_config.interval_hours }} —á–∞—Å.
                            {% endif %}
                        </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞</h6>
                                <span id="config-sources" class="badge bg-info">
                            <i class="bi bi-list"></i> {{ automation_config.scraping_sources | join(', ') }}
                        </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h6>–í–∫–ª—é—á–µ–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã:</h6>
                <div id="config-stages" class="d-flex flex-wrap gap-2">
                    {% set stage_names = {
                        'scraping': '–ü–∞—Ä—Å–∏–Ω–≥',
                        'photo_processing': '–§–æ—Ç–æ',
                        'duplicate_processing': '–î—É–±–ª–∏–∫–∞—Ç—ã',
                        'realtor_detection': '–†–∏—ç–ª—Ç–æ—Ä—ã',
                        'elasticsearch_reindex': '–ü–æ–∏—Å–∫'
                    } %}
                    {% for stage_key, enabled in automation_config.enabled_stages.items() %}
                        <span class="badge {% if enabled %}bg-success{% else %}bg-secondary{% endif %} me-1">
                            <i class="bi {% if enabled %}bi-check-circle{% else %}bi-x-circle{% endif %}"></i>
                            {{ stage_names[stage_key] or stage_key }}
                        </span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/automation.js?v=3.6"></script>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    console.log('üìã –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —à–∞–±–ª–æ–Ω–∞');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º AutomationManager
    console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º AutomationManager:', window.automationManager);
    console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–ª–µ–º–µ–Ω—Ç scraping-sources:', document.getElementById('scraping-sources'));
    
    if (window.automationManager) {
        console.log('üîß AutomationManager —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
        window.automationManager.loadScrapingSources();
    } else {
        console.log('‚è≥ –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AutomationManager...');
        let attempts = 0;
        const maxAttempts = 10;
        
        const checkAutomationManager = () => {
            attempts++;
            console.log(`üîç –ü–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts}: AutomationManager =`, window.automationManager);
            
            if (window.automationManager) {
                console.log('‚úÖ AutomationManager –Ω–∞–π–¥–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏...');
                window.automationManager.loadScrapingSources();
            } else if (attempts < maxAttempts) {
                console.log('‚è≥ AutomationManager –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤, –∂–¥–µ–º...');
                setTimeout(checkAutomationManager, 500);
            } else {
                console.error('‚ùå AutomationManager –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫');
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                const container = document.getElementById('scraping-sources');
                if (container) {
                    container.innerHTML = `
                        <div class="col-12 text-center">
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle"></i>
                                –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AutomationManager
                            </div>
                        </div>
                    `;
                } else {
                    console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç scraping-sources –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM');
                }
            }
        };
        
        setTimeout(checkAutomationManager, 1000);
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ WebSocket —Å–æ–±—ã—Ç–∏–π
    if (window.realtimeClient) {
        console.log('üì° WebSocket –∫–ª–∏–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏...');
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
        window.realtimeClient.on('automation_status', function(data) {
            console.log('ü§ñ –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω:', data);
            updateAutomationStatus(data);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
        window.realtimeClient.on('scraping_progress', function(data) {
            console.log('üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–∞—Ä—Å–∏–Ω–≥–∞:', data);
            updateScrapingProgress(data);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞
        window.realtimeClient.on('scraping_sources_update', function(data) {
            console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞:', data);
            if (window.automationManager) {
                window.automationManager.updateScrapingSources(data.jobs || [], data.sources || []);
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
        window.realtimeClient.on('duplicate_processing_progress', function(data) {
            console.log('üîÑ –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏:', data);
            updateDuplicateProcessingProgress(data);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞
        window.realtimeClient.on('pipeline_stats', function(data) {
            console.log('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞:', data);
            updatePipelineStats(data);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –ø–∞–π–ø–ª–∞–π–Ω–∞
        window.realtimeClient.on('pipeline_started', function(data) {
            console.log('üöÄ –ü–∞–π–ø–ª–∞–π–Ω –Ω–∞—á–∞—Ç:', data);
            updatePipelineStatus('running', '–ü–∞–π–ø–ª–∞–π–Ω –∑–∞–ø—É—â–µ–Ω');
        });
        
        window.realtimeClient.on('pipeline_completed', function(data) {
            console.log('‚úÖ –ü–∞–π–ø–ª–∞–π–Ω –∑–∞–≤–µ—Ä—à–µ–Ω:', data);
            updatePipelineStatus('completed', '–ü–∞–π–ø–ª–∞–π–Ω –∑–∞–≤–µ—Ä—à–µ–Ω');
        });
        
        window.realtimeClient.on('pipeline_error', function(data) {
            console.log('‚ùå –û—à–∏–±–∫–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞:', data);
            updatePipelineStatus('error', '–û—à–∏–±–∫–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞');
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket
        window.realtimeClient.on('connected', function(data) {
            console.log('üîó WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏');
            // –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—à–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ WebSocket –∫–ª–∏–µ–Ω—Ç–µ
        });
    } else {
        console.log('‚ö†Ô∏è WebSocket –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏');
    }
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
function updateAutomationStatus(data) {
    console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏:', data);
    
    const statusElement = document.getElementById('pipeline-status');
    if (statusElement) {
        const status = data.pipeline_status || data.status;
        const statusText = getStatusText(status);
        statusElement.className = `badge ${getStatusBadgeClass(status)} pulse`;
        statusElement.innerHTML = `<i class="bi ${getStatusIcon(status)}"></i> ${statusText}`;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∞–π–ø–ª–∞–π–Ω–∞
    if (data.stats) {
        updatePipelineStats(data.stats);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    updateConfigInfo(data);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    updateTimeInfo(data);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ø
    updateCurrentStage(data);
}

function getStatusText(status) {
    const statusMap = {
        'idle': '–ì–æ—Ç–æ–≤',
        'running': '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è',
        'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω',
        'error': '–û—à–∏–±–∫–∞',
        'paused': '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
    };
    return statusMap[status] || status;
}

function getStatusIcon(status) {
    const iconMap = {
        'idle': 'bi-circle-fill',
        'running': 'bi-arrow-clockwise',
        'completed': 'bi-check-circle-fill',
        'error': 'bi-exclamation-triangle-fill',
        'paused': 'bi-pause-circle-fill'
    };
    return iconMap[status] || 'bi-question-circle-fill';
}

function updateConfigInfo(data) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã —á–µ—Ä–µ–∑ WebSocket
    const autoModeElement = document.getElementById('config-auto-mode');
    const intervalElement = document.getElementById('config-interval');
    const sourcesElement = document.getElementById('config-sources');
    const stagesElement = document.getElementById('config-stages');
    
    if (autoModeElement && data.is_auto_mode !== undefined) {
        autoModeElement.className = data.is_auto_mode ? 'badge bg-success' : 'badge bg-danger';
        autoModeElement.innerHTML = data.is_auto_mode ? '<i class="bi bi-check-circle"></i> –í–∫–ª—é—á–µ–Ω' : '<i class="bi bi-x-circle"></i> –û—Ç–∫–ª—é—á–µ–Ω';
    }
    
    if (intervalElement && (data.interval_minutes !== undefined || data.interval_hours !== undefined)) {
        intervalElement.className = 'badge bg-primary';
        if (data.interval_minutes && data.interval_minutes < 60) {
            intervalElement.innerHTML = `<i class="bi bi-clock"></i> ${data.interval_minutes} –º–∏–Ω.`;
        } else {
            intervalElement.innerHTML = `<i class="bi bi-clock"></i> ${data.interval_hours} —á–∞—Å.`;
        }
    }
    
    if (sourcesElement && data.scraping_sources) {
        sourcesElement.className = 'badge bg-info';
        const sourcesText = data.scraping_sources.join(', ');
        sourcesElement.innerHTML = `<i class="bi bi-list"></i> ${sourcesText}`;
    }
    
    if (stagesElement && data.enabled_stages) {
        stagesElement.innerHTML = '';
        const stageNames = {
            'scraping': '–ü–∞—Ä—Å–∏–Ω–≥',
            'photo_processing': '–§–æ—Ç–æ',
            'duplicate_processing': '–î—É–±–ª–∏–∫–∞—Ç—ã',
            'realtor_detection': '–†–∏—ç–ª—Ç–æ—Ä—ã',
            'elasticsearch_reindex': '–ü–æ–∏—Å–∫'
        };
        
        Object.entries(data.enabled_stages).forEach(([stageKey, enabled]) => {
            const stageBadge = document.createElement('span');
            stageBadge.className = `badge ${enabled ? 'bg-success' : 'bg-secondary'} me-1`;
            stageBadge.innerHTML = `
                <i class="bi ${enabled ? 'bi-check-circle' : 'bi-x-circle'}"></i>
                ${stageNames[stageKey] || stageKey}
            `;
            stagesElement.appendChild(stageBadge);
        });
    }
}

function updateTimeInfo(data) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏
    const lastRunStartElement = document.getElementById('last-run-start');
    const lastRunEndElement = document.getElementById('last-run-end');
    const nextRunElement = document.getElementById('next-run');
    
    if (lastRunStartElement && data.last_run_start) {
        lastRunStartElement.textContent = formatDateTime(data.last_run_start);
    }
    
    if (lastRunEndElement && data.last_run_end) {
        lastRunEndElement.textContent = formatDateTime(data.last_run_end);
    }
    
    if (nextRunElement && data.next_run_scheduled) {
        nextRunElement.textContent = formatDateTime(data.next_run_scheduled);
    }
}

function updateCurrentStage(data) {
    const currentStageDiv = document.getElementById('current-stage');
    const currentStageNameElement = document.getElementById('current-stage-name');
    const currentProgressElement = document.getElementById('current-progress');
    const currentStageDetailsElement = document.getElementById('current-stage-details');
    
    if (data.current_stage && data.stage_details) {
        const stageDetails = data.stage_details[data.current_stage];
        if (stageDetails) {
            currentStageDiv.style.display = 'block';
            currentStageNameElement.textContent = stageDetails.name || data.current_stage;
            
            if (stageDetails.progress) {
                const progress = stageDetails.progress;
                const total = progress.total || progress.processed || 0;
                const completed = progress.completed || progress.processed || 0;
                const percentage = total > 0 ? (completed / total) * 100 : 0;
                
                currentProgressElement.style.width = `${percentage}%`;
                currentProgressElement.setAttribute('aria-valuenow', percentage);
                
                currentStageDetailsElement.textContent = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${completed} –∏–∑ ${total}`;
            }
        }
    } else {
        currentStageDiv.style.display = 'none';
    }
}

function formatDateTime(dateString) {
    if (!dateString) return '‚Äî';
    try {
        const date = new Date(dateString);
        return date.toLocaleString('ru-RU');
    } catch (e) {
        return '‚Äî';
    }
}

function updateScrapingProgress(data) {
    const progressElement = document.getElementById('current-progress');
    if (progressElement && data.progress !== undefined) {
        progressElement.style.width = `${data.progress}%`;
        progressElement.setAttribute('aria-valuenow', data.progress);
    }
    
    const stageElement = document.getElementById('current-stage-name');
    if (stageElement) {
        stageElement.textContent = data.source || '–ü–∞—Ä—Å–∏–Ω–≥';
    }
    
    const detailsElement = document.getElementById('current-stage-details');
    if (detailsElement) {
        detailsElement.textContent = data.details || `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${data.processed || 0}`;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞
    const currentStageDiv = document.getElementById('current-stage');
    if (currentStageDiv) {
        currentStageDiv.style.display = 'block';
    }
}

function updateDuplicateProcessingProgress(data) {
    const progressElement = document.getElementById('current-progress');
    if (progressElement && data.progress !== undefined) {
        progressElement.style.width = `${data.progress}%`;
        progressElement.setAttribute('aria-valuenow', data.progress);
    }
    
    const stageElement = document.getElementById('current-stage-name');
    if (stageElement) {
        stageElement.textContent = '–ü–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤';
    }
    
    const detailsElement = document.getElementById('current-stage-details');
    if (detailsElement) {
        detailsElement.textContent = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${data.processed || 0}, –Ω–∞–π–¥–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ${data.duplicates_found || 0}`;
    }
}

function updatePipelineStats(data) {
    console.log('üìä –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∞–π–ø–ª–∞–π–Ω–∞:', data);
    
    if (data.new_ads !== undefined) {
        const element = document.getElementById('stat-new-ads');
        if (element) element.textContent = data.new_ads;
    }
    
    if (data.processed_ads !== undefined) {
        const element = document.getElementById('stat-processed-ads');
        if (element) element.textContent = data.processed_ads;
    }
    
    if (data.duplicates_found !== undefined) {
        const element = document.getElementById('stat-duplicates');
        if (element) element.textContent = data.duplicates_found;
    }
    
    if (data.realtors_found !== undefined) {
        const element = document.getElementById('stat-realtors');
        if (element) element.textContent = data.realtors_found;
    }
}

function updatePipelineStatus(status, text) {
    const statusElement = document.getElementById('pipeline-status');
    if (statusElement) {
        statusElement.className = `badge ${getStatusBadgeClass(status)} pulse`;
        statusElement.innerHTML = `<i class="bi bi-circle-fill"></i> ${text}`;
    }
}

function getStatusBadgeClass(status) {
    switch (status) {
        case 'running': return 'bg-primary';
        case 'completed': return 'bg-success';
        case 'error': return 'bg-danger';
        case 'warning': return 'bg-warning';
        default: return 'bg-secondary';
    }
}
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ª–æ–≥–æ–≤ -->
<div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logsModalLabel">
                    <i class="bi bi-file-text"></i> –õ–æ–≥–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="logsModalBody" class="logs-container">
                    <!-- –õ–æ–≥–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<style>
.logs-container {
    max-height: 400px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
}

.log-entry {
    margin-bottom: 5px;
    padding: 2px 0;
    border-bottom: 1px solid #e9ecef;
}

.log-entry:last-child {
    border-bottom: none;
}

.log-timestamp {
    color: #6c757d;
    font-size: 11px;
}

.log-level {
    font-weight: bold;
    margin: 0 5px;
}

.log-level.log-info {
    color: #0d6efd;
}

.log-level.log-warning {
    color: #ffc107;
}

.log-level.log-error {
    color: #dc3545;
}

.log-level.log-debug {
    color: #6c757d;
}

.log-message {
    color: #212529;
}
</style>
</div>
{% endblock %} 