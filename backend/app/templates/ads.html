{% extends "base.html" %}

{% block title %}–û–±—ä—è–≤–ª–µ–Ω–∏—è{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1>
                <i class="bi bi-card-list"></i> –û–±—ä—è–≤–ª–µ–Ω–∏—è 
                <span id="total-info">({{ total }} –Ω–∞–π–¥–µ–Ω–æ)</span>
                {% if current_filters.query %}
                    <span class="badge bg-primary ms-2">
                        <i class="bi bi-search"></i> "{{ current_filters.query }}"
                    </span>
                {% endif %}
            </h1>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-funnel"></i> –§–∏–ª—å—Ç—Ä—ã</h5>
                </div>
                <div class="card-body">
                    <form id="filters-form">
                        <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">–ü–æ–∏—Å–∫ –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" name="query" 
                                           placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞..." 
                                           value="{{ current_filters.query or '' }}"
                                           onkeypress="if(event.key==='Enter') applyFiltersWithHistory()">
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearSearch()">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    –ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É, –æ–ø–∏—Å–∞–Ω–∏—é, –∞–¥—Ä–µ—Å—É –æ–±—ä—è–≤–ª–µ–Ω–∏—è
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label class="form-label">–ì–æ—Ä–æ–¥</label>
                                <select class="form-select" name="city">
                                    <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                                    {% for city in cities %}
                                        <option value="{{ city }}" {% if current_filters.city == city %}selected{% endif %}>{{ city }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">–†–∞–π–æ–Ω</label>
                                <select class="form-select" name="district">
                                    <option value="">–í—Å–µ —Ä–∞–π–æ–Ω—ã</option>
                                    {% for district in districts %}
                                        <option value="{{ district }}" {% if current_filters.district == district %}selected{% endif %}>{{ district }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</label>
                                <select class="form-select" name="property_type">
                                    <option value="">–õ—é–±–æ–π</option>
                                    {% for pt in property_types %}
                                        <option value="{{ pt }}" {% if current_filters.property_type == pt %}selected{% endif %}>{{ pt }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">–¢–∏–ø —Å–¥–µ–ª–∫–∏</label>
                                <select class="form-select" name="listing_type">
                                    <option value="">–õ—é–±–∞—è</option>
                                    {% for lt in listing_types %}
                                        <option value="{{ lt }}" {% if current_filters.listing_type == lt %}selected{% endif %}>{{ lt }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">–¶–µ–Ω–∞ –æ—Ç</label>
                                <input type="number" class="form-control" name="min_price" placeholder="–¶–µ–Ω–∞" value="{{ current_filters.min_price or '' }}">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">–¶–µ–Ω–∞ –¥–æ</label>
                                <input type="number" class="form-control" name="max_price" placeholder="–¶–µ–Ω–∞" value="{{ current_filters.max_price or '' }}">
                            </div>
                            </div>
                            
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label class="form-label">–ü–ª–æ—â–∞–¥—å –æ—Ç</label>
                                <input type="number" class="form-control" name="min_area" placeholder="–º¬≤" value="{{ current_filters.min_area or '' }}">
                            </div>
                            
                            <div class="col-md-2 mb-3">
                                <label class="form-label">–ü–ª–æ—â–∞–¥—å –¥–æ</label>
                                <input type="number" class="form-control" name="max_area" placeholder="–º¬≤" value="{{ current_filters.max_area or '' }}">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                                <select class="form-select" name="source_name">
                                    <option value="">–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</option>
                                    {% for src in sources %}
                                        <option value="{{ src }}" {% if current_filters.source_name == src %}selected{% endif %}>{{ src }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">–ö–æ–º–Ω–∞—Ç—ã</label>
                                <select class="form-select" name="rooms">
                                    <option value="">–õ—é–±–æ–µ</option>
                                    <option value="1" {% if current_filters.rooms == 1 %}selected{% endif %}>1</option>
                                    <option value="2" {% if current_filters.rooms == 2 %}selected{% endif %}>2</option>
                                    <option value="3" {% if current_filters.rooms == 3 %}selected{% endif %}>3</option>
                                    <option value="4" {% if current_filters.rooms == 4 %}selected{% endif %}>4+</option>
                                </select>
                            </div>
                            
                            <div class="col-md-2 mb-3">
                                <label class="form-label">–†–∏—ç–ª—Ç–æ—Ä</label>
                                <select class="form-select" name="is_realtor">
                                    <option value="">–í—Å–µ</option>
                                    <option value="true" {% if current_filters.is_realtor %}selected{% endif %}>–î–∞</option>
                                    <option value="false" {% if current_filters.is_realtor == false %}selected{% endif %}>–ù–µ—Ç</option>
                                </select>
                            </div>
                            
                            <div class="col-md-2 mb-3">
                                <label class="form-label">–î—É–±–ª–∏–∫–∞—Ç—ã</label>
                                <select class="form-select" name="has_duplicates">
                                    <option value="">–í—Å–µ</option>
                                    <option value="true" {% if current_filters.has_duplicates %}selected{% endif %}>–ï—Å—Ç—å</option>
                                    <option value="false" {% if current_filters.has_duplicates == false %}selected{% endif %}>–ù–µ—Ç</option>
                                </select>
                            </div>
                            
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary me-2" onclick="applyFiltersWithHistory()">
                                    <i class="bi bi-search"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                                </button>
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="clearFilters()">
                                    <i class="bi bi-x-circle"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
                                </button>
                                {% if current_filters.query or current_filters.city or current_filters.district or current_filters.min_price or current_filters.max_price %}
                                <span class="badge bg-info">
                                    <i class="bi bi-funnel-fill"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- –û–±—ä—è–≤–ª–µ–Ω–∏—è -->
    <div class="row" id="ads-container">
        {% if ads %}
            {% for ad in ads %}
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card ad-card h-100">
                    <div class="position-relative">
                        {% if ad.photos and ad.photos|length > 0 %}
                            <img src="{{ ad.photos[0].url }}" class="ad-image" alt="–§–æ—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è">
                        {% else %}
                            <div class="ad-image bg-light d-flex align-items-center justify-content-center">
                                <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                            </div>
                        {% endif %}
                        
                        {% if ad.duplicates_count > 0 %}
                            <span class="badge bg-warning duplicate-badge">{{ ad.duplicates_count }} –¥—É–±–ª.</span>
                        {% endif %}
                        
                        {% if ad.realtor_id or ad.realtor %}
                            <span class="badge bg-info position-absolute" style="top: 10px; left: 10px;">–†–∏—ç–ª—Ç–æ—Ä</span>
                        {% endif %}
                    </div>
                    
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title">{{ ad.title[:60] }}{% if ad.title|length > 60 %}...{% endif %}</h6>
                        
                        {% if ad.price %}
                            <div class="ad-price mb-2">
                                {% if ad.currency == 'USD' %}${{ "{:,.0f}".format(ad.price) }}
                                {% elif ad.currency == 'SOM' %}{{ "{:,.0f}".format(ad.price) }} —Å–æ–º
                                {% elif ad.currency == 'EUR' %}‚Ç¨{{ "{:,.0f}".format(ad.price) }}
                                {% else %}{{ "{:,.0f}".format(ad.price) }} {{ ad.currency or '' }}
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="ad-price mb-2 text-muted">–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</div>
                        {% endif %}
                        
                        <div class="ad-meta mb-3">
                            {% if ad.area_sqm %}{{ ad.area_sqm }} –º¬≤ ‚Ä¢ {% endif %}
                            {% if ad.rooms %}{{ ad.rooms }} –∫–æ–º–Ω. ‚Ä¢ {% endif %}
                            {% if ad.floor %}{{ ad.floor }} —ç—Ç–∞–∂{% endif %}
                            {% if ad.location %}
                                <br><i class="bi bi-geo-alt"></i> {{ ad.location.city }}{% if ad.location.district %}, {{ ad.location.district }}{% endif %}
                            {% endif %}
                        </div>
                        
                        <div class="mt-auto">
                            <a href="/ad/{{ ad.id }}" class="btn btn-primary btn-sm">
                                <i class="bi bi-eye"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </a>
                            {% if ad.realtor_id %}
                                <a href="/realtor/{{ ad.realtor_id }}" class="btn btn-outline-info btn-sm ms-1">
                                    <i class="bi bi-person"></i> –†–∏—ç–ª—Ç–æ—Ä
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="text-center text-muted py-5">
                    <i class="bi bi-search display-4 d-block mb-3"></i>
                    <h4>–û–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <div id="pagination">
        {% if total > limit %}
        <div class="row mt-4">
            <div class="col-12 d-flex justify-content-center">
                <nav>
                    <ul class="pagination">
                        {% set current_page = (offset // limit) + 1 %}
                        {% set total_pages = (total + limit - 1) // limit %}
                        
                        <!-- –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                        {% if current_page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="?{{ request.query_string.decode().replace('offset=' + offset|string, 'offset=' + ((current_page - 2) * limit)|string) if 'offset=' in request.query_string.decode() else request.query_string.decode() + ('&' if request.query_string else '') + 'offset=' + ((current_page - 2) * limit)|string }}">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}
                        
                        <!-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü -->
                        {% for page_num in range(1, total_pages + 1) %}
                            {% if page_num == current_page %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% elif page_num <= 3 or page_num > total_pages - 3 or (page_num >= current_page - 2 and page_num <= current_page + 2) %}
                                <li class="page-item">
                                    <a class="page-link" href="?{{ request.query_string.decode().replace('offset=' + offset|string, 'offset=' + ((page_num - 1) * limit)|string) if 'offset=' in request.query_string.decode() else request.query_string.decode() + ('&' if request.query_string else '') + 'offset=' + ((page_num - 1) * limit)|string }}">
                                        {{ page_num }}
                                    </a>
                                </li>
                            {% elif page_num == 4 and current_page > 6 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% elif page_num == total_pages - 3 and current_page < total_pages - 5 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        <!-- –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                        {% if current_page < total_pages %}
                            <li class="page-item">
                                <a class="page-link" href="?{{ request.query_string.decode().replace('offset=' + offset|string, 'offset=' + (current_page * limit)|string) if 'offset=' in request.query_string.decode() else request.query_string.decode() + ('&' if request.query_string else '') + 'offset=' + (current_page * limit)|string }}">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω—ã - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->

{% endblock %}

{% block scripts %}
<script src="/static/js/utils.js?v=2.1"></script>
<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
function applyFilters() {
    const form = document.getElementById('filters-form');
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
        if (value.trim() !== '') {
            params.append(key, value);
        }
    }
    
    window.location.href = '/ads?' + params.toString();
}

function clearFilters() {
    window.location.href = '/ads';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
document.addEventListener('DOMContentLoaded', function() {
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ WebSocket —Å–æ–±—ã—Ç–∏–π
    if (window.realtimeClient) {
        console.log('üì° WebSocket –∫–ª–∏–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π...');
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π
        window.realtimeClient.on('new_ad_created', function(data) {
            console.log('üè† –ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:', data);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
            const totalInfo = document.getElementById('total-info');
            if (totalInfo) {
                const currentText = totalInfo.textContent;
                const match = currentText.match(/\((\d+) –Ω–∞–π–¥–µ–Ω–æ\)/);
                if (match) {
                    const currentCount = parseInt(match[1]) + 1;
                    totalInfo.textContent = `(${currentCount} –Ω–∞–π–¥–µ–Ω–æ)`;
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    totalInfo.style.animation = 'pulse 0.5s ease-in-out';
                    setTimeout(() => {
                        totalInfo.style.animation = '';
                    }, 500);
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (window.showNotification) {
                window.showNotification('info', 
                    `–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ: ${data.title ? data.title.substring(0, 50) + '...' : '–û–±—ä—è–≤–ª–µ–Ω–∏–µ'}`);
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        window.realtimeClient.on('stats_update', function(data) {
            console.log('üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π:', data);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (data.total_ads !== undefined) {
                const totalInfo = document.getElementById('total-info');
                if (totalInfo) {
                    totalInfo.textContent = `(${data.total_ads} –Ω–∞–π–¥–µ–Ω–æ)`;
                }
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞
        window.realtimeClient.on('scraping_started', function(data) {
            console.log('üöÄ –ü–∞—Ä—Å–∏–Ω–≥ –Ω–∞—á–∞—Ç:', data);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (window.showNotification) {
                window.showNotification('info', `–ü–∞—Ä—Å–∏–Ω–≥ –Ω–∞—á–∞—Ç: ${data.source || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}`);
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞
        window.realtimeClient.on('scraping_completed', function(data) {
            console.log('‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω:', data);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (window.showNotification) {
                window.showNotification('success', 
                    `–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${data.total_processed || 0} –æ–±—ä—è–≤–ª–µ–Ω–∏–π`);
            }
            
            // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
            setTimeout(() => {
                if (confirm('–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω! –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π?')) {
                    window.location.reload();
                }
            }, 2000);
        });
    } else {
        console.log('‚ö†Ô∏è WebSocket –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π');
    }
});
</script>
{% endblock %} 